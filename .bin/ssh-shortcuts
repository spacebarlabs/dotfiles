#!/bin/bash

# CONFIGURATION - use environment variables if set, otherwise use defaults
CONFIG_FILE="${CONFIG_FILE:-$HOME/.ssh/config}"
# The folder you want to bookmark
OUTPUT_DIR="${OUTPUT_DIR:-$HOME/.ssh/SFTP}"

# Cleanup - use trash-put if available, otherwise use rm -rf
if [ -d "$OUTPUT_DIR" ]; then
    if command -v trash-put &> /dev/null; then
        trash-put "$OUTPUT_DIR"
    else
        echo "Warning: 'trash-put' not found, using rm -rf instead. Install with: sudo apt install trash-cli"
        rm -rf "$OUTPUT_DIR"
    fi
fi
mkdir -p "$OUTPUT_DIR"

echo "Reading hosts from $CONFIG_FILE..."

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Error: SSH config file not found at $CONFIG_FILE"
    exit 1
fi

while read -r line; do
    if [[ "$line" =~ ^[Hh][Oo][Ss][Tt]\ (.+) ]]; then
        hosts="${BASH_REMATCH[1]}"
        
        # Disable globbing temporarily to prevent wildcard expansion
        set -f
        for host in $hosts; do
            # Skip wildcards
            if [[ "$host" == *"*"* ]] || [[ "$host" == *"?"* ]]; then
                continue
            fi

            # Sanitize hostname to prevent directory traversal
            # Remove any path separators and other dangerous characters
            safe_host="${host//[\/\\]/_}"
            
            # Skip if hostname is empty after sanitization
            if [ -z "$safe_host" ]; then
                continue
            fi

            # File extension is .url
            FILE_PATH="$OUTPUT_DIR/${safe_host}.url"
            
            # Simple Windows-style .url format
            cat <<EOF > "$FILE_PATH"
[InternetShortcut]
URL=sftp://${host}
EOF
            
            echo "  âœ… Created: $FILE_PATH"
        done
        # Re-enable globbing
        set +f
    fi
done < "$CONFIG_FILE"

echo "Done! SFTP shortcuts created in $OUTPUT_DIR"
