#!/bin/bash

# Configuration
STATE_FILE="${XDG_RUNTIME_DIR:-$HOME/.cache}/annex-watchdog-timestamp"
CHECK_FILE="${XDG_RUNTIME_DIR:-$HOME/.cache}/annex-watchdog-lastcheck"
LOG_DIR="$HOME/.log"
LOG_FILE="$LOG_DIR/annex-watchdog.log"
MAX_LOG_SIZE=1048576  # 1MB in bytes
MAX_LOG_FILES=5       # Keep 5 rotated logs
# If a crash happens within this many seconds of the last one, it's a loop.
THRESHOLD_SECONDS=600 # 10 minutes

# Set DBUS address for notifications
export DBUS_SESSION_BUS_ADDRESS="${DBUS_SESSION_BUS_ADDRESS:-unix:path=/run/user/$(id -u)/bus}"

# Ensure log directory exists
mkdir -p "$LOG_DIR"

# Log rotation function
rotate_logs() {
    if [ -f "$LOG_FILE" ]; then
        local size=$(stat -f%z "$LOG_FILE" 2>/dev/null || stat -c%s "$LOG_FILE" 2>/dev/null || echo 0)
        if [ "$size" -ge "$MAX_LOG_SIZE" ]; then
            # Rotate existing logs
            for i in $(seq $((MAX_LOG_FILES - 1)) -1 1); do
                if [ -f "$LOG_FILE.$i" ]; then
                    mv "$LOG_FILE.$i" "$LOG_FILE.$((i + 1))"
                fi
            done
            # Move current log to .1
            mv "$LOG_FILE" "$LOG_FILE.1"
        fi
    fi
}

# Rotate logs if needed
rotate_logs

# Record that we checked (always, regardless of outcome)
CURRENT_TIME=$(date +%s)
mkdir -p "$(dirname "$CHECK_FILE")"
echo "$CURRENT_TIME" > "$CHECK_FILE"

# Check if git-annex assistant is running
if pgrep -f "git-annex assistant" > /dev/null; then
    exit 0
fi

# --- If we are here, the process is DEAD ---

# Check if we have a record of a previous restart
if [ -f "$STATE_FILE" ]; then
    LAST_RESTART=$(cat "$STATE_FILE")
    # Validate that the state file contains a valid timestamp
    if ! [[ "$LAST_RESTART" =~ ^[0-9]+$ ]]; then
        echo "$(date): Invalid state file content. Resetting." >> "$LOG_FILE"
        rm -f "$STATE_FILE"
    else
        DIFF=$((CURRENT_TIME - LAST_RESTART))

        if [ "$DIFF" -lt "$THRESHOLD_SECONDS" ]; then
            # CRASH LOOP DETECTED
            # Send a visual notification to the desktop (works in Gnome)
            notify-send -u critical "Git Annex Failure" "The assistant is crashing repeatedly. Watchdog has stopped restarting it."
            
            echo "$(date): Crash loop detected (last restart was ${DIFF}s ago). Aborting." >> "$LOG_FILE"
            exit 1
        fi
    fi
fi

# --- Restart Sequence ---

# Ensure the directory for the state file exists
mkdir -p "$(dirname "$STATE_FILE")"

# Update the timestamp
echo "$CURRENT_TIME" > "$STATE_FILE"

# Restart
if git-annex assistant --autostart; then
    # Log
    echo "$(date): Git Annex crashed and was restarted." >> "$LOG_FILE"

    # Notify (Optional: let you know it happened, but isn't critical yet)
    notify-send -u normal "Git Annex Watchdog" "Process crashed and was successfully restarted."
else
    # Restart failed
    echo "$(date): Failed to restart git-annex assistant." >> "$LOG_FILE"
    notify-send -u critical "Git Annex Watchdog" "Failed to restart the assistant. Please check manually."
    exit 1
fi
