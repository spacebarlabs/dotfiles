name: Update Submodules

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  update-submodules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check all submodules are shallow
        run: |
          bash .github/scripts/check-shallow-submodules.sh

      - name: Update submodules
        id: update
        run: |
          # Update all submodules to their latest commits
          git submodule update --remote --merge
          
          # Check if there are any changes (including unstaged, staged, and untracked files)
          if [ -z "$(git status --porcelain)" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No submodule updates available"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Submodules updated successfully"
          fi

      - name: Get submodule changes
        if: steps.update.outputs.has_changes == 'true'
        id: changes
        run: |
          # Get detailed list of updated submodules using git submodule status
          CHANGES=$(git submodule status | { grep "^+" || true; })
          if [ -n "$CHANGES" ]; then
            {
              echo "changes<<EOF"
              echo "Updated submodules:"
              echo "$CHANGES"
              echo ""
              echo "Detailed changes:"
              git diff --submodule=log || true
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "changes=No detailed changes available" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: steps.update.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update submodules to latest versions"
          branch: automated/update-submodules
          delete-branch: true
          title: "chore: Update submodules to latest versions"
          body: |
            ## Automated Submodule Updates
            
            This PR updates all submodules to their latest versions.
            
            ### Changes
            ```
            ${{ steps.changes.outputs.changes }}
            ```
            
            ---
            *This PR was created automatically by the weekly submodule update workflow.*
          labels: |
            dependencies
            automated
