#!/bin/bash

# Runs automatically one time when first cloning.
# Run manually with `yadm bootstrap` as needed.

# File containing the subdirectory mappings
SUBDIR_CONFIG="$HOME/.gitmodules_subdirs"

if [ -f "$SUBDIR_CONFIG" ]; then
  echo "Linking submodule subdirectories (relatively)..."

  # Filter comments/empty lines and read each mapping
  grep -v '^#' "$SUBDIR_CONFIG" | grep -v '^$' | while read -r line; do
    # Split by the colon
    SOURCE_PATH=$(echo "${line%%:*}" | xargs)
    TARGET_PATH=$(echo "${line#*:}" | xargs)

    # Use absolute paths for the command, but -r makes the link relative
    FULL_SOURCE="$HOME/$SOURCE_PATH"
    FULL_TARGET="$HOME/$TARGET_PATH"

    if [ -d "$FULL_SOURCE" ]; then
      # Ensure the parent directory of the target exists
      mkdir -p "$(dirname "$FULL_TARGET")"

      # -s: symbolic
      # -f: remove existing destination files
      # -n: treat destination that is a symlink to a directory as a normal file
      # -r: create symbolic links relative to link location (GNU only)
      ln -sfnr "$FULL_SOURCE" "$FULL_TARGET"

      # Verify it's relative
      REL_TARGET=$(readlink "$FULL_TARGET")
      echo "✅ Linked $TARGET_PATH -> $REL_TARGET"
    else
      echo "⚠️  Source not found: $SOURCE_PATH"
    fi
  done
fi

if command -v gsettings >/dev/null; then
    echo "Applying Dracula settings to GNOME Terminal (Directly)..."

    # 1. Get the UUID of the default profile
    PROFILE_UUID=$(gsettings get org.gnome.Terminal.ProfilesList default | tr -d "'")

    # 2. Define the dconf path for this profile
    PROFILE_PATH="/org/gnome/terminal/legacy/profiles:/:$PROFILE_UUID"

    # 3. Ensure the profile is in the global list (Fixes "empty list" issues)
    CURRENT_LIST=$(gsettings get org.gnome.Terminal.ProfilesList list)
    if [[ "$CURRENT_LIST" == *"@as []"* ]] || [[ "$CURRENT_LIST" == *"[]"* ]]; then
        gsettings set org.gnome.Terminal.ProfilesList list "['$PROFILE_UUID']"
    fi

    # 4. Inject Dracula Colors directly (Bypassing the flaky install.sh script)
    #    Palette: Dracula standard
    dconf write "$PROFILE_PATH/palette" "['#21222C', '#FF5555', '#50FA7B', '#F1FA8C', '#BD93F9', '#FF79C6', '#8BE9FD', '#F8F8F2', '#6272A4', '#FF6E6E', '#69FF94', '#FFFFA5', '#D6ACFF', '#FF92DF', '#A4FFFF', '#FFFFFF']"

    #    Background: #282A36 (Dark Purple)
    dconf write "$PROFILE_PATH/background-color" "'#282A36'"

    #    Foreground: #F8F8F2 (White-ish)
    dconf write "$PROFILE_PATH/foreground-color" "'#F8F8F2'"

    #    Settings to ensure colors are actually used
    dconf write "$PROFILE_PATH/use-theme-colors" "false"
    dconf write "$PROFILE_PATH/bold-color-same-as-fg" "true"
    dconf write "$PROFILE_PATH/use-theme-transparency" "false"

    echo "✅ Dracula theme applied."
fi

# Optional: Link the dircolors file for shell usage if you want it
DIRCOLORS_SRC="$HOME/.sbl-submodules/dracula-gnome-terminal/src/dircolors"
if [ -f "$DIRCOLORS_SRC" ] && [ ! -f "$HOME/.dircolors" ]; then
    ln -s "$DIRCOLORS_SRC" "$HOME/.dircolors"
fi

# Define the path
GNOME_EXT_DIR="$HOME/.local/share/gnome-shell/extensions"

# Ensure the directory exists (yadm usually handles this via submodules, but good for safety)
mkdir -p "$GNOME_EXT_DIR"

echo "Checking for GNOME Shell Extensions in $GNOME_EXT_DIR..."

# Check if the gnome-extensions CLI tool exists before proceeding
if command -v gnome-extensions >/dev/null 2>&1; then
    echo "GNOME extensions tool found. Activating submodules..."

    # Get valid UUIDs based on folders containing metadata.json
    valid_extensions=$(find "$GNOME_EXT_DIR" -maxdepth 2 -name "metadata.json" -printf '%h\n' | xargs -I {} basename {})

    # Read currently enabled extensions to avoid redundant calls
    enabled_list=$(gsettings get org.gnome.shell enabled-extensions 2>/dev/null)

    for uuid in $valid_extensions; do
        if [[ "$enabled_list" != *"$uuid"* ]]; then
            echo "Activating: $uuid"
            gnome-extensions enable "$uuid"
        else
            echo "$uuid is already active."
        fi
    done
else
    echo "gnome-extensions CLI not found. Skipping activation."
fi

# Configure GNOME Pomodoro settings if installed
if command -v gsettings >/dev/null 2>&1; then
    # Check if the GNOME Pomodoro schema is installed
    if gsettings list-schemas | grep -q "org.gnome.pomodoro.plugins.gnome"; then
        echo "Configuring GNOME Pomodoro settings..."
        gsettings set org.gnome.pomodoro.plugins.gnome blur-effect false
        echo "✅ GNOME Pomodoro blur-effect disabled."
    else
        echo "GNOME Pomodoro not installed. Skipping pomodoro settings."
    fi
fi

# Warn if mise is not installed
if ! command -v mise &> /dev/null; then
    echo "⚠️  WARNING: mise is not installed. Tool version management will not be available."
    echo "   Install mise from: https://mise.jdx.dev/"
fi

# --- Framework Audio Buzz Fix ---
VENDOR=$(cat /sys/class/dmi/id/sys_vendor 2>/dev/null | tr -d '\0' | xargs)
CONFIG_FILE="/etc/modprobe.d/audio-fix.conf"
FIX_LINE="options snd_hda_intel power_save=0"

if [[ "$VENDOR" == "Framework" ]]; then
    echo ">> Framework Laptop detected."

    # Check if file exists AND contains the exact fix line
    if [ -f "$CONFIG_FILE" ] && grep -qF "$FIX_LINE" "$CONFIG_FILE"; then
        echo "   [OK] Audio fix is already applied in $CONFIG_FILE."
    else
        echo "   [..] Applying audio power-save fix..."
        echo "$FIX_LINE" | sudo tee "$CONFIG_FILE" > /dev/null

        # Verify it actually wrote correctly
        if grep -qF "$FIX_LINE" "$CONFIG_FILE"; then
            echo "   [OK] Fix applied successfully. Please reboot."
        else
            echo "   [!!] Failed to apply fix. Please check sudo permissions."
        fi
    fi
else
    echo ">> Not a Framework laptop. Skipping audio fix."
fi
